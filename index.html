<!DOCTYPE html>
<html lang="en">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Break Register Login</title>

<style>
body {
  font-family: Arial, sans-serif;
  background: #eef2f5;
}

.card {
  max-width: 360px;
  margin: 80px auto;
  background: #fff;
  padding: 25px;
  border-radius: 10px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.1);
}

h2 {
  text-align: center;
  margin-bottom: 20px;
}

.input-group {
  position: relative;
  margin-bottom: 15px;
}

input {
  width: 100%;
  padding: 12px;
  font-size: 15px;
  border: 1px solid #ccc;
  border-radius: 6px;
}

.eye {
  position: absolute;
  right: 12px;
  top: 12px;
  cursor: pointer;
  font-size: 18px;
  color: #555;
}

button {
  width: 100%;
  padding: 12px;
  background: #0d6efd;
  color: #fff;
  border: none;
  border-radius: 6px;
  font-size: 16px;
  cursor: pointer;
}

#msg {
  margin-top: 12px;
  text-align: center;
  font-size: 14px;
}
</style>
</head>

<body>

<div class="card">
  <h2>Break Register Login</h2>

  <div class="input-group">
    <input id="loginname" placeholder="Login ID">
  </div>

  <div class="input-group">
    <input id="password" type="password" placeholder="Password">
    <span class="eye" onclick="togglePwd()">üëÅ</span>
  </div>

  <button onclick="login()">Login</button>
  <div id="msg"></div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

/* üîë SUPABASE CONFIG */
const SUPABASE_URL = "https://ntfbcahivqivgjdexkgf.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im50ZmJjYWhpdnFpdmdqZGV4a2dmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0MTU0MTgsImV4cCI6MjA4Mjk5MTQxOH0.o6mrBZp7FeV3_paMsRq807w8cR7NHEAuIfbyLmIfnnc";

const supabase = createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY,
  { auth: { persistSession: true } }
);

/* üëÅ Show / Hide Password */
window.togglePwd = function () {
  const p = document.getElementById("password");
  p.type = p.type === "password" ? "text" : "password";
};

/* üîê LOGIN LOGIC */
window.login = async function () {
  const loginname = document.getElementById("loginname").value.trim();
  const password  = document.getElementById("password").value;
  const msg = document.getElementById("msg");

  msg.style.color = "red";
  msg.innerText = "";

  if (!loginname || !password) {
    msg.innerText = "Enter login ID and password";
    return;
  }

  const email = loginname + "@breakregister.com";

  /* 1Ô∏è‚É£ Check user exists in user_master */
  const { data: user, error: userErr } = await supabase
    .from("user_master")
    .select("role_id, is_active")
    .eq("loginname", loginname)
    .single();

  if (userErr || !user) {
    msg.innerText = "User not registered. Contact admin.";
    return;
  }

  if (!user.is_active) {
    msg.innerText = "User is deactivated. Contact admin.";
    return;
  }

  /* 2Ô∏è‚É£ Try normal login */
  const { error: loginErr } = await supabase.auth.signInWithPassword({
    email, password
  });

  /* 3Ô∏è‚É£ First-time password setup */
  if (loginErr) {
    if (loginErr.message.includes("Invalid login credentials")) {
      const { error: signupErr } = await supabase.auth.signUp({
        email, password
      });

      if (signupErr) {
        msg.innerText = signupErr.message;
        return;
      }

      msg.style.color = "green";
      msg.innerText = "Password created. Please login again.";
      return;
    }

    msg.innerText = loginErr.message;
    return;
  }

  /* 4Ô∏è‚É£ Login success */
  msg.style.color = "green";
  msg.innerText =
    user.role_id === 1
      ? "STAFF Login Successful"
      : "HOD Login Successful";

  // üîú next step: redirect to dashboard
};
</script>

</body>
</html>
